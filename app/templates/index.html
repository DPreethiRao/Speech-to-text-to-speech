<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Text-to-Speech & Speech-to-Text</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea, input {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        audio, a {
            display: block;
            margin-top: 10px;
        }
        #recordingStatus {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Text-to-Speech & Speech-to-Text</h1>

    <!-- Text-to-Speech Form -->
    <form method="POST" enctype="multipart/form-data">
        <h2>Text-to-Speech</h2>
        <textarea name="text" placeholder="Enter text to convert to speech"></textarea>
        <button type="submit">Convert to Speech</button>
    </form>

    <h3>Generated Audio Files</h3>
    {% for audio in audio_files %}
        {% if audio.endswith('.mp3') %}
        <audio controls>
            <source src="{{ url_for('static', filename='audio/' + audio) }}" type="audio/mpeg">
        </audio>
        {% endif %}
    {% endfor %}

    <!-- Speech-to-Text Recording -->
    <h2>Speech-to-Text (Record Audio)</h2>
    <button id="startRecordingBtn">Start Recording</button>
    <button id="stopRecordingBtn" style="display:none;" disabled>Stop Recording</button>
    <div id="recordingStatus"></div>
    <form id="recordingForm" method="POST" enctype="multipart/form-data" style="display:none;">
        <input type="file" name="audio_data" id="audioDataInput" accept="audio/wav">
        <button type="submit">Upload Audio</button>
    </form>

    <h3>Transcriptions</h3>
    {% for transcription in transcription_files %}
        <a href="{{ url_for('static', filename='audio/' + transcription) }}" target="_blank">{{ transcription }}</a>
    {% endfor %}

    <script>
        let mediaRecorder;
        let audioChunks = [];

        // Start recording when button is clicked
        document.getElementById('startRecordingBtn').addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audioFile = new File([audioBlob], 'recorded_audio.wav', { type: 'audio/wav' });

                // Show status
                document.getElementById('recordingStatus').textContent = "Recording stopped. Please upload the audio.";

                // Create FormData object and append the file
                const formData = new FormData();
                formData.append('audio_data', audioFile);

                // Prepare the form for uploading
                const inputFile = document.getElementById('audioDataInput');
                inputFile.files = null; // Reset any previous files
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(audioFile);
                inputFile.files = dataTransfer.files;

                // Show the upload form
                document.getElementById('recordingForm').style.display = 'block';
            };

            // Disable Start and Enable Stop Button
            document.getElementById('startRecordingBtn').disabled = true;
            document.getElementById('stopRecordingBtn').style.display = 'inline';
            document.getElementById('stopRecordingBtn').disabled = false;
        });

        // Stop recording when button is clicked
        document.getElementById('stopRecordingBtn').addEventListener('click', () => {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());

            // Disable Stop and Enable Start Button
            document.getElementById('stopRecordingBtn').style.display = 'none';
            document.getElementById('stopRecordingBtn').disabled = true;
            document.getElementById('startRecordingBtn').disabled = false;
        });
    </script>
</body>
</html>
